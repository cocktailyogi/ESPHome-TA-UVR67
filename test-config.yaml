# test-config.yaml
# ESPHome Test-Konfiguration für sensordlbus Development
# Basierend auf der Produktions-Config von iot-heizung
# WICHTIG: Diese Config auf einem separaten Test-ESP32 verwenden!

substitutions:
  devicename: dlbus-test-dev
  friendly_name: DLBus Test
  device_description: ESP32 Development Device for sensordlbus testing

esphome:
  name: ${devicename}
  comment: ${device_description}

esp32:
  board: wemos_d1_mini32
  framework:
    type: arduino

# WiFi-Konfiguration - ANPASSEN!
wifi:
  ssid: "DEIN_WIFI_SSID"           # ← HIER ANPASSEN!
  password: "DEIN_WIFI_PASSWORT"   # ← HIER ANPASSEN!
  
  # Optional: Manuelle IP für einfacheres Debugging
  # manual_ip:
  #   static_ip: 192.168.1.151     # Andere IP als Produktion!
  #   gateway: 192.168.1.1
  #   subnet: 255.255.255.0
  
  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: ${devicename} Fallback
    password: "TestFallback123"

captive_portal:

# Enable logging - VERBOSE für Development
logger:
  level: VERBOSE  # Sehr ausführlich für Entwicklung
  logs:
    sensor: DEBUG
    sensordlbus: VERBOSE
    component: DEBUG

# Enable Home Assistant API
api:
  #encryption:
  #  key: "test1234567890123456789012345678901234567890123="  # 44 Zeichen Base64

ota:
  - platform: esphome
    password: "test123"  # Einfaches Passwort für Tests
  
status_led:
  pin:
    number: GPIO2
    inverted: False

# ========================================
# WICHTIG: Lokale Komponente für Development
# ========================================
external_components:
  # Für lokales Testen (Standard-Modus für Entwicklung)
  - source:
      type: local
      path: components  # Pfad relativ zu dieser YAML
    components: [ sensordlbus ]
    refresh: 0s  # Immer neu laden

  # Alternative: Von GitHub laden (auskommentiert)
  # - source:
  #     type: git
  #     url: https://github.com/cocktailyogi/ESPHome-TA-UVR67
  #     ref: development  # Nutze development-Branch für Tests
  #   components: [ sensordlbus ]
  #   refresh: 0s

# ========================================
# Sensoren
# ========================================
sensor:
  - platform: uptime
    name: "${friendly_name} Uptime"
    id: uptime_sensor

  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s
    id: wifi_signal_sensor

  # DLBus Sensor - wie in Produktion
  - platform: sensordlbus
    id: device_type_sensor
    devicetype:
      name: "${friendly_name} Device Type"
      id: device_type
    
    # Temperatursensoren mit Test-Namen
    temperature_1:
      name: "${friendly_name} Temp 1 (Rücklauf)"
      id: temp1
      filters:
        - filter_out: nan
    
    temperature_2:
      name: "${friendly_name} Temp 2 (Außen)"
      id: temp2
      filters:
        - filter_out: nan
    
    temperature_3:
      name: "${friendly_name} Temp 3 (Vorlauf)"
      id: temp3
      filters:
        - filter_out: nan
    
    temperature_4:
      name: "${friendly_name} Temp 4"
      id: temp4
      filters:
        - filter_out: nan
    
    temperature_5:
      name: "${friendly_name} Temp 5 (Puffer 40%)"
      id: temp5
      filters:
        - filter_out: nan
    
    temperature_6:
      name: "${friendly_name} Temp 6 (Puffer 90%)"
      id: temp6
      filters:
        - filter_out: nan
    
    # Output Status
    output_a1:
      name: "${friendly_name} Output A1 (Deckenheizung)"
      id: output_a1
    
    output_a2:
      name: "${friendly_name} Output A2"
      id: output_a2
    
    output_a3:
      name: "${friendly_name} Output A3 (Gasbrenner)"
      id: output_a3
    
    output_a4:
      name: "${friendly_name} Output A4"
      id: output_a4
    
    output_a5:
      name: "${friendly_name} Output A5"
      id: output_a5
    
    output_a6:
      name: "${friendly_name} Output A6"
      id: output_a6
    
    output_a7:
      name: "${friendly_name} Output A7"
      id: output_a7

# ========================================
# Binary Sensoren
# ========================================
binary_sensor:
  - platform: status
    name: "${friendly_name} Status"

# ========================================
# Text Sensoren für Debug-Info
# ========================================
text_sensor:
  - platform: version
    name: "${friendly_name} ESPHome Version"
  
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP Address"
    ssid:
      name: "${friendly_name} Connected SSID"
    mac_address:
      name: "${friendly_name} MAC Address"

# ========================================
# Switches
# ========================================
switch:
  - platform: restart
    name: "${friendly_name} Restart"
    id: restart_switch

# ========================================
# Buttons für Tests
# ========================================
button:
  - platform: safe_mode
    name: "${friendly_name} Safe Mode Boot"
    entity_category: diagnostic

# ========================================
# Debug Interval (alle 60s Status-Log)
# ========================================
interval:
  - interval: 60s
    then:
      - logger.log:
          format: "=== Test Device läuft - Uptime: %.0fs - WiFi: %.0f dBm ==="
          args: 
            - 'id(uptime_sensor).state'
            - 'id(wifi_signal_sensor).state'

# ========================================
# NOTIZEN FÜR ENTWICKLUNG
# ========================================
#
# Hardware:
# - Board: Wemos D1 Mini32 (ESP32)
# - GPIO 27: DL-Bus Datenleitung (definiert in DLBus.h)
# - GPIO 2: Status LED
#
# Erste Schritte:
# 1. WiFi-Daten oben anpassen
# 2. ESP32 per USB anschließen
# 3. Kompilieren: esphome compile test-config.yaml
# 4. Erstes Upload via USB: esphome upload test-config.yaml --device COM3
# 5. Danach OTA möglich: esphome upload test-config.yaml --device 192.168.1.151
# 6. Logs: esphome logs test-config.yaml
#
# Development Workflow:
# 1. Code in components/sensordlbus/ ändern
# 2. Kompilieren (testet Syntax)
# 3. Upload auf Test-Device
# 4. Logs beobachten
# 5. Wenn OK: git commit & push
# 6. Produktions-Device in Home Assistant neu installieren
#
# Logger-Level:
# - VERBOSE: Alles (Development)
# - DEBUG: Viel (Testing)
# - INFO: Normal (Staging)
# - WARN: Nur Warnungen (Production)
#
# External Components:
# - local: Lädt aus lokalem Ordner (schnell, für aktive Entwicklung)
# - git: Lädt von GitHub (langsamer, für Tests vor Merge)
#
# ========================================